-- Setup Supabase pg_cron scheduled jobs for task automation
-- These jobs will automatically trigger the edge functions at specified intervals

-- Enable pg_cron extension if not already enabled
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 1. Daily Overdue Task Escalation - Runs every day at 9:00 AM UTC
SELECT cron.schedule(
  'daily-task-escalation',
  '0 9 * * *',
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/task-automation-daily',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.supabase_anon_key')
    ),
    body := '{}'::jsonb
  ) AS request_id;
  $$
);

-- 2. Weekly Deadline Adjustment Suggestions - Runs every Monday at 8:00 AM UTC
SELECT cron.schedule(
  'weekly-deadline-adjustment',
  '0 8 * * 1',
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/task-automation-weekly',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.supabase_anon_key')
    ),
    body := '{}'::jsonb
  ) AS request_id;
  $$
);

-- 3. Weekly Workload Rebalancing - Runs every Monday at 10:00 AM UTC
SELECT cron.schedule(
  'weekly-workload-rebalancing',
  '0 10 * * 1',
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/task-automation-rebalance',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.supabase_anon_key')
    ),
    body := '{}'::jsonb
  ) AS request_id;
  $$
);

-- 4. Weekly Digest Generation - Runs every Sunday at 6:00 PM UTC (18:00)
SELECT cron.schedule(
  'weekly-task-digest',
  '0 18 * * 0',
  $$
  SELECT net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/task-automation-digest',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.settings.supabase_anon_key')
    ),
    body := '{}'::jsonb
  ) AS request_id;
  $$
);

-- View all scheduled cron jobs
-- To check if jobs are scheduled, run:
-- SELECT * FROM cron.job;

-- Unschedule jobs if needed (for maintenance or updates)
-- SELECT cron.unschedule('daily-task-escalation');
-- SELECT cron.unschedule('weekly-deadline-adjustment');
-- SELECT cron.unschedule('weekly-workload-rebalancing');
-- SELECT cron.unschedule('weekly-task-digest');

-- Monitor cron job execution history
-- SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 100;
